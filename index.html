<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بازی ریاضی پیشرفته</title>
  <style>
    body {
      font-family: 'Vazir', sans-serif;
      background-color: #f0f4f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      direction: rtl;
    }
    #game-container {
      background: #ffffff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      width: 450px;
      text-align: center;
      transition: background 0.3s ease;
    }
    h1 { color: #333; }
    #question {
      font-size: 28px;
      margin: 20px 0;
      min-height: 50px;
      transition: color 0.3s ease;
    }
    input[type="number"] {
      padding: 12px;
      font-size: 20px;
      width: 65%;
      text-align: center;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    button {
      padding: 12px 25px;
      margin: 10px 5px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { opacity: 0.85; }
    #check { background-color: #4CAF50; color: white; }
    #stop { background-color: #f44336; color: white; }
    #start { background-color: #2196F3; color: white; }
    #menu {
      margin-top: 15px;
      text-align: center;
    }
    #menu label { margin: 0 5px; font-size: 14px; }
    #score { margin-top: 10px; font-size: 18px; color: #555; }
    #timer {
      font-size: 18px;
      margin-top: 5px;
      color: #555;
    }
    .flash {
      animation: flashBG 0.5s;
    }
    @keyframes flashBG {
      0% { background-color: #fff; }
      50% { background-color: #c8e6c9; }
      100% { background-color: #fff; }
    }
    .flash-wrong {
      animation: flashWrong 0.5s;
    }
    @keyframes flashWrong {
      0% { background-color: #fff; }
      50% { background-color: #ffcdd2; }
      100% { background-color: #fff; }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>بازی ریاضی پیشرفته</h1>
    <div id="question">برای شروع دکمه شروع را بزن!</div>
    <input type="number" id="answer" placeholder="جواب" />
    <div>
      <button id="check">بررسی</button>
      <button id="start">شروع</button>
      <button id="stop">استپ</button>
    </div>
    <div id="score">امتیاز: 0</div>
    <div id="timer">زمان: 15 ثانیه</div>
    <div id="menu">
      <label><input type="checkbox" id="add" checked> جمع</label>
      <label><input type="checkbox" id="sub" checked> تفریق</label>
      <label><input type="checkbox" id="mul" checked> ضرب</label>
      <label><input type="checkbox" id="div" checked> تقسیم</label>
    </div>
  </div>

  <script>
    const questionEl = document.getElementById('question');
    const answerEl = document.getElementById('answer');
    const checkBtn = document.getElementById('check');
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const gameContainer = document.getElementById('game-container');

    let score = 0;
    let currentAnswer = 0;
    let gameActive = false;
    let timeLeft = 15;
    let timerInterval;

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateQuestion() {
      const operations = [];
      if(document.getElementById('add').checked) operations.push('+');
      if(document.getElementById('sub').checked) operations.push('-');
      if(document.getElementById('mul').checked) operations.push('*');
      if(document.getElementById('div').checked) operations.push('/');

      if(operations.length === 0) return null;

      const op1 = operations[randomInt(0, operations.length-1)];
      const op2 = operations[randomInt(0, operations.length-1)];

      let nums = [randomInt(1,20), randomInt(1,20), randomInt(1,20)];
      if(op1 === '/') nums[1] = randomInt(1,10);
      if(op2 === '/') nums[2] = randomInt(1,10);

      const questionStr = `${nums[0]} ${op1} ${nums[1]} ${op2} ${nums[2]}`;

      // محاسبه چپ به راست
      let answer = nums[0];
      const ops = [op1, op2];
      for(let i=0; i<ops.length; i++){
        if(ops[i] === '+') answer += nums[i+1];
        else if(ops[i] === '-') answer -= nums[i+1];
        else if(ops[i] === '*') answer *= nums[i+1];
        else if(ops[i] === '/') answer = Math.floor(answer / nums[i+1]);
      }

      currentAnswer = answer;
      questionEl.textContent = questionStr.replace(/\d+/g, n => n.toLocaleString('fa'));
    }

    function startTimer() {
      clearInterval(timerInterval);
      timeLeft = 15;
      timerEl.textContent = `زمان: ${timeLeft} ثانیه`;
      timerInterval = setInterval(() => {
        timeLeft--;
        timerEl.textContent = `زمان: ${timeLeft} ثانیه`;
        if(timeLeft <= 0){
          clearInterval(timerInterval);
          flashWrong();
          generateQuestion();
          startTimer();
        }
      }, 1000);
    }

    function flashCorrect() {
      gameContainer.classList.add('flash');
      setTimeout(()=> gameContainer.classList.remove('flash'), 500);
    }

    function flashWrong() {
      gameContainer.classList.add('flash-wrong');
      setTimeout(()=> gameContainer.classList.remove('flash-wrong'), 500);
    }

    function startGame() {
      gameActive = true;
      score = 0;
      scoreEl.textContent = 'امتیاز: ' + score;
      generateQuestion();
      startTimer();
    }

    function stopGame() {
      gameActive = false;
      clearInterval(timerInterval);
      questionEl.textContent = 'بازی متوقف شد!';
    }

    checkBtn.addEventListener('click', () => {
      if(!gameActive) return;
      const userAnswer = parseInt(answerEl.value);
      if(userAnswer === currentAnswer){
        score++;
        scoreEl.textContent = 'امتیاز: ' + score;
        flashCorrect();
      } else {
        flashWrong();
      }
      answerEl.value = '';
      generateQuestion();
      startTimer();
    });

    startBtn.addEventListener('click', startGame);
    stopBtn.addEventListener('click', stopGame);

    answerEl.addEventListener('keyup', e => {
      if(e.key === 'Enter') checkBtn.click();
    });
  </script>
</body>
</html>
